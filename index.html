<!DOCTYPE html>
<html>
<head>
    <title>Tathya Pro - Cloud Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        :root { --accent: #00e676; --bg: #0a0a0a; --card: #161616; --blue: #2196f3; --error: #ff5252; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; }
        
        #enrollModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .modal-input { width: 100%; padding: 15px; background: #111; border: 1px solid #333; color: #fff; border-radius: 10px; margin-bottom: 15px; font-size: 16px; text-align: center; }
        
        .bio-ring-container { position: relative; width: 280px; height: 280px; margin: 10px 0; }
        .inner-display { position: absolute; top: 30px; left: 30px; width: 220px; height: 220px; border-radius: 50%; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; border: 2px solid #222; }
        #v { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 0.3; filter: grayscale(1); }
        #pulseGraph { position: absolute; width: 100%; height: 80px; bottom: 10px; z-index: 5; pointer-events: none; }
        
        #targetCircle { position: absolute; width: 90px; height: 90px; border: 2px dashed #444; border-radius: 50%; z-index: 15; }
        #targetCircle.locked { border: 4px solid var(--accent); transform: scale(0.8); box-shadow: 0 0 20px var(--accent); }

        .btn-main { width: 100%; padding: 18px; border-radius: 12px; border: none; background: var(--accent); color: #000; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-small { flex: 1; background: #111; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 10px; }
        #calBar { width: 0%; height: 8px; background: var(--accent); transition: width 0.5s; border-radius: 4px; margin: 10px 0; border: 1px solid #333; }
        
        #forceStart { display: none; color: var(--blue); margin-top: 20px; font-size: 12px; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

    <div id="enrollModal">
        <h2 style="color:var(--accent);">TATHYA HANDSHAKE</h2>
        <p style="font-size:12px; color:#888; margin-bottom:20px;">Retrieving Biometric Identity...</p>
        <input type="text" id="userName" class="modal-input" placeholder="Abhishek Thakur">
        <div style="display:flex; gap:10px; width:100%; margin-bottom:15px;">
            <button class="btn-small" onclick="toggleLens()">â†º LENS</button>
            <button id="modalFlash" class="btn-small" onclick="toggleFlash()">ðŸ”¦ FLASH</button>
        </div>
        <button id="handshakeBtn" onclick="performHandshake()" class="btn-main">RESTORE PROGRESS</button>
        <div id="forceStart" onclick="bypassCloud()">Cloud taking too long? Force Start Local.</div>
    </div>

    <div id="scanView" style="width:100%; max-width:450px; padding:20px; display:flex; flex-direction:column; align-items:center;">
        <div id="statusMsg" style="font-size:10px; font-weight:bold; color:var(--blue); margin-bottom:10px;">SIGNAL STANDBY</div>
        
        <div class="bio-ring-container">
            <svg class="progress-ring" width="280" height="280">
                <circle stroke="#222" stroke-width="8" fill="transparent" r="130" cx="140" cy="140"/>
                <circle id="clockProgress" style="stroke: var(--accent); stroke-dasharray: 816; stroke-dashoffset: 816;" stroke-width="8" fill="transparent" r="130" cx="140" cy="140"/>
            </svg>
            <div class="inner-display">
                <video id="v" autoplay playsinline muted></video>
                <div id="targetCircle"></div>
                <div id="timer" style="font-size:14px; z-index:10; font-weight:bold;">READY</div>
                <div id="gluResult" style="font-size:60px; font-weight:800; color:var(--accent); z-index:10; margin:0;">--</div>
                <canvas id="pulseGraph"></canvas>
            </div>
        </div>

        <div style="width:100%; text-align:center;">
            <div id="calBar"></div>
            <div id="calText" style="font-size:9px; color:#555;">SYNC LEVEL: 0</div>
        </div>

        <div style="display:flex; gap:10px; width:100%; margin: 20px 0;">
            <button class="btn-small" onclick="toggleLens()">â†º LENS</button>
            <button id="mainFlash" class="btn-small" onclick="toggleFlash()">ðŸ”¦ FLASH</button>
        </div>

        <button id="scanBtn" class="btn-main" onclick="runAnalysis()">START BIO-SCAN</button>
    </div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzpOeeA-knysis8HzxtHSKxNaBb8Dq9RR96myBBQRPmoJJ0hQCTu8x6z2K6KnllcQxsMQ/exec";
    
    const v = document.getElementById('v'), c = document.getElementById('c'), ctx = c.getContext('2d');
    const clock = document.getElementById('clockProgress'), pGraph = document.getElementById('pulseGraph'), pCtx = pGraph.getContext('2d');
    
    let stream, torch = false, pulseArr = [], devices = [], cameraIdx = 0, isLocked = false;
    let enrollmentData = null, cal = { bInt: 218.75, bGlu: 100, sens: 5.5, syncCount: 1 };

    async function init() {
        try {
            const d = await navigator.mediaDevices.enumerateDevices();
            devices = d.filter(i => i.kind === 'videoinput');
            await setupCamera();
            
            const stored = localStorage.getItem('tathya_enroll');
            if(stored) {
                enrollmentData = JSON.parse(stored);
                cal = JSON.parse(localStorage.getItem('tathya_cal')) || cal;
                document.getElementById('enrollModal').style.display = 'none';
                updateUI();
            }
            
            setInterval(monitorSignal, 150);
        } catch(e) { console.log(e); }
    }

    async function performHandshake() {
        const name = document.getElementById('userName').value.trim();
        if(!name) return;
        
        document.getElementById('handshakeBtn').innerText = "QUERYING DATABASE...";
        document.getElementById('forceStart').style.display = "block";

        try {
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({type: "REVIVE_REQUEST", query: name})
            });
            const data = await response.json();
            
            if(data.found) {
                enrollmentData = { name: data.name, uid: data.uid, density: parseFloat(data.density) };
                cal = { bInt: parseFloat(data.baseline), bGlu: parseFloat(data.bGlu), sens: parseFloat(data.sens), syncCount: parseInt(data.syncCount) };
            } else {
                enrollmentData = { name: name, uid: "T-"+Math.floor(1000+Math.random()*9000), density: 0.99 };
            }
            finalizeLogin();
        } catch(e) {
            console.log("Database handshake failed. Using local fail-safe.");
        }
    }

    function bypassCloud() {
        const name = document.getElementById('userName').value.trim() || "User";
        enrollmentData = { name: name, uid: "LOCAL-RESTORE", density: 0.99 };
        finalizeLogin();
    }

    function finalizeLogin() {
        localStorage.setItem('tathya_enroll', JSON.stringify(enrollmentData));
        localStorage.setItem('tathya_cal', JSON.stringify(cal));
        document.getElementById('enrollModal').style.display = 'none';
        updateUI();
    }

    function monitorSignal() {
        if(!torch || !stream) return;
        ctx.drawImage(v, 0, 0, 50, 50);
        const pix = ctx.getImageData(0, 0, 50, 50).data;
        let r = 0; for(let i=0; i<pix.length; i+=4) r += pix[i];
        let intensity = r / (pix.length/4);
        
        if(intensity > 130) {
            isLocked = true; 
            document.getElementById('targetCircle').className = "locked";
            document.getElementById('statusMsg').innerText = "SIGNAL LOCKED";
            document.getElementById('statusMsg').style.color = "#00e676";
        } else {
            isLocked = false; 
            document.getElementById('targetCircle').className = "";
            document.getElementById('statusMsg').innerText = "PLACE FINGER";
            document.getElementById('statusMsg').style.color = "#ff5252";
        }
    }

    async function setupCamera() {
        if(stream) stream.getTracks().forEach(t => t.stop());
        const constraints = { video: { deviceId: devices[cameraIdx]?.deviceId, facingMode: 'environment' } };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        v.srcObject = stream;
    }

    function runAnalysis() {
        if(!isLocked) return alert("Signal Lock Required");
        let buffer = []; pulseArr = [];
        document.getElementById('scanBtn').disabled = true;
        const start = Date.now();
        const timer = setInterval(() => {
            const elapsed = Date.now() - start;
            clock.style.strokeDashoffset = 816 - (Math.min(elapsed/45000,1) * 816);
            document.getElementById('timer').innerText = `${Math.ceil((45000-elapsed)/1000)}s`;
            
            ctx.drawImage(v, 0, 0, 50, 50);
            let pix = ctx.getImageData(0, 0, 50, 50).data, r = 0;
            for(let i=0; i<pix.length; i+=4) r += pix[i];
            let inst = r / (pix.length/4);
            
            if(elapsed > 5000) buffer.push(inst);
            pulseArr.push(inst); if(pulseArr.length > 50) pulseArr.shift();
            drawPulse();
            
            if (elapsed >= 45000) {
                clearInterval(timer);
                const avg = buffer.reduce((a,b)=>a+b,0) / buffer.length;
                const result = Math.round(cal.bGlu + (cal.bInt - avg) * (cal.sens / enrollmentData.density));
                document.getElementById('gluResult').innerText = result;
                document.getElementById('scanBtn').disabled = false;
                fetch(GOOGLE_SCRIPT_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({uid: enrollmentData.uid, name: enrollmentData.name, val: result, raw: avg, type: "SCAN"})});
            }
        }, 100);
    }

    function drawPulse() {
        pCtx.clearRect(0,0, pGraph.width, pGraph.height);
        pCtx.beginPath(); pCtx.strokeStyle = "#00e676"; pCtx.lineWidth = 3;
        const max = Math.max(...pulseArr), min = Math.min(...pulseArr), range = (max-min)||1;
        pulseArr.forEach((p, i) => {
            const x = (i/50)*pGraph.width, y = pGraph.height-((p-min)/range*pGraph.height);
            if(i===0) pCtx.moveTo(x,y); else pCtx.lineTo(x,y);
        });
        pCtx.stroke();
    }

    function updateUI() {
        document.getElementById('calBar').style.width = Math.min((cal.syncCount / 10) * 100, 100) + "%";
        document.getElementById('calText').innerText = "SYNC LEVEL: " + cal.syncCount;
    }

    async function toggleFlash() {
        const track = stream.getVideoTracks()[0];
        torch = !torch;
        await track.applyConstraints({ advanced: [{ torch: torch }] });
        document.getElementById('modalFlash').style.background = torch ? "#00e676" : "#111";
        document.getElementById('mainFlash').style.background = torch ? "#00e676" : "#111";
    }

    function toggleLens() {
        cameraIdx = (cameraIdx + 1) % devices.length;
        setupCamera();
    }

    window.onload = init;
</script>
<canvas id="c" width="50" height="50" style="display:none;"></canvas>
</body>
</html>
