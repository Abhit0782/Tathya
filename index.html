<!DOCTYPE html>
<html>
<head>
    <title>Smart Strip - Live Real-Time Analyzer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: #e0e0e0; margin: 0; padding: 15px; text-align: center; }
        .container { max-width: 600px; margin: auto; }
        
        /* Live Video Preview - Small & Discreet */
        #video-container { position: relative; width: 120px; height: 120px; margin: 10px auto; border-radius: 50%; overflow: hidden; border: 3px solid #00e676; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* Glucose Display */
        .live-display { background: #1a1a1a; padding: 20px; border-radius: 20px; margin: 15px 0; border: 1px solid #333; }
        .glucose-val { font-size: 64px; color: #00e676; font-weight: bold; font-family: monospace; }
        .intensity-sub { color: #2196f3; font-size: 18px; }

        /* Real-Time Pulse Graph */
        canvas#pulseGraph { width: 100%; height: 100px; background: #000; border-radius: 10px; margin: 10px 0; }

        .btn { padding: 15px 30px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin: 5px; width: 100%; font-size: 16px; }
        .btn-start { background: #00e676; color: #000; }
        .btn-calib { background: #1a237e; color: white; }
        
        .history { text-align: left; font-size: 12px; background: #111; padding: 10px; border-radius: 10px; max-height: 150px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color:#00e676; margin-bottom:5px;">Smart Strip LIVE</h2>
    
    <div id="video-container">
        <video id="liveVideo" autoplay playsinline muted></video>
    </div>

    <div class="live-display">
        <div style="font-size: 12px; color: #888;">ESTIMATED GLUCOSE</div>
        <div class="glucose-val" id="liveGlucose">--</div>
        <div style="font-size: 12px; color: #888;">mg/dL</div>
        <div class="intensity-sub">Intensity: <span id="liveInt">0.00</span></div>
    </div>

    <canvas id="pulseGraph"></canvas>

    <button class="btn btn-start" onclick="initCamera()">1. START LIVE SCAN</button>
    
    <div class="live-display" style="padding: 10px;">
        <input type="number" id="calibRef" placeholder="Real Glucometer Value" style="padding:10px; width:60%; border-radius:5px; border:none;">
        <button class="btn btn-calib" style="width:30%; padding:10px;" onclick="setBaseline()">Sync</button>
    </div>

    <h3>History Log</h3>
    <div class="history" id="log">No data yet. Scan and sync to save.</div>
</div>

<canvas id="procCanvas" width="50" height="50" style="display:none;"></canvas>

<script>
    const video = document.getElementById('liveVideo');
    const procCanvas = document.getElementById('procCanvas');
    const pCtx = procCanvas.getContext('2d', {willReadFrequently: true});
    const pulseCanvas = document.getElementById('pulseGraph');
    const gCtx = pulseCanvas.getContext('2d');

    let calibration = JSON.parse(localStorage.getItem('live_calib')) || { baselineInt: 220, baselineGlu: 100, sensitivity: 4.5 };
    let intensityHistory = [];
    let isRunning = false;

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', frameRate: { ideal: 30 } } 
            });
            video.srcObject = stream;
            isRunning = true;
            requestAnimationFrame(processLoop);
        } catch (err) {
            alert("Camera access denied. Please enable camera permissions.");
        }
    }

    function processLoop() {
        if (!isRunning) return;

        // 1. Capture & Analyze Pixels
        pCtx.drawImage(video, 0, 0, 50, 50);
        const pix = pCtx.getImageData(0, 0, 50, 50).data;
        let redSum = 0;
        for (let i = 0; i < pix.length; i += 4) redSum += pix[i];
        const currentInt = redSum / (pix.length / 4);

        // 2. Add to smoothing history (Median Filter)
        intensityHistory.push(currentInt);
        if (intensityHistory.length > 30) intensityHistory.shift();

        // 3. Filtered Average (Ignoring outliers)
        const sorted = [...intensityHistory].sort((a,b) => a-b);
        const filteredAvg = sorted[Math.floor(sorted.length / 2)]; // Median is more stable than average

        // 4. Calculate Glucose
        // Glucose = Baseline + (BaselineInt - CurrentInt) * Sensitivity
        const glucose = calibration.baselineGlu + (calibration.baselineInt - filteredAvg) * calibration.sensitivity;

        // 5. Update UI
        document.getElementById('liveInt').innerText = filteredAvg.toFixed(2);
        if (filteredAvg > 50) { // Only show if finger is detected
            document.getElementById('liveGlucose').innerText = Math.round(glucose);
        } else {
            document.getElementById('liveGlucose').innerText = "PLACE FINGER";
        }

        drawPulse(intensityHistory);
        requestAnimationFrame(processLoop);
    }

    function setBaseline() {
        const real = parseFloat(document.getElementById('calibRef').value);
        if (!real) return alert("Enter real glucometer value first!");
        
        calibration.baselineInt = parseFloat(document.getElementById('liveInt').innerText);
        calibration.baselineGlu = real;
        
        localStorage.setItem('live_calib', JSON.stringify(calibration));
        
        // Log the event
        const entry = `<div>[${new Date().toLocaleTimeString()}] Synced: ${real}mg/dL at ${calibration.baselineInt} Int</div>`;
        document.getElementById('log').innerHTML = entry + document.getElementById('log').innerHTML;
        alert("Calibration Synced!");
    }

    function drawPulse(data) {
        gCtx.clearRect(0, 0, pulseCanvas.width, pulseCanvas.height);
        gCtx.beginPath();
        gCtx.strokeStyle = '#00e676';
        gCtx.lineWidth = 2;
        
        const max = Math.max(...data);
        const min = Math.min(...data);
        const range = max - min || 1;

        data.forEach((p, i) => {
            const x = (i / data.length) * pulseCanvas.width;
            const y = pulseCanvas.height - ((p - min) / range * pulseCanvas.height);
            if (i === 0) gCtx.moveTo(x, y);
            else gCtx.lineTo(x, y);
        });
        gCtx.stroke();
    }
</script>
</body>
</html>
